import React, { createContext, useContext, useState, useEffect, useMemo, ReactNode, useCallback } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';

export type Language = 'en' | 'pt';

const LANGUAGE_KEY = '@rigor_language';

const translations = {
  en: {
    tabs: {
      today: 'Today',
      progress: 'Progress',
      squads: 'Squads',
      trophies: 'Trophies',
      profile: 'Profile',
    },
    today: {
      noContract: 'No active contract',
      noContractDesc: 'Sign your first contract to begin.',
      signFirst: 'Sign my first contract',
      day: 'DAY',
      completed: 'COMPLETED',
      failed: 'FAILED',
      before: 'before',
      remaining: 'remaining',
      streak: 'Streak',
      noReturn: 'No return',
      dayCompleted: 'Day completed',
      done: 'Done',
      newDay: 'New Day!',
      newDayQuestion: 'Did you complete your mission yesterday?',
      yesCompleted: 'Yes, I completed it!',
      noFailed: 'No, I failed...',
      beHonest: 'Be honest! Your progress depends on it.',
    },
    progress: {
      title: 'Progress',
      active: 'active',
      rate: 'RATE',
      done: 'DONE',
      fails: 'FAILS',
      consistencyMap: 'CONSISTENCY MAP',
      legendDone: 'Done',
      legendFail: 'Fail',
      legendCritical: 'Critical',
      insights: 'INSIGHTS',
      bestStreak: 'Best streak',
      currentStreak: 'Current streak',
      day: 'day',
      days: 'days',
    },
    squads: {
      title: 'Squads',
      create: 'Create',
      join: 'Join',
      noSquads: 'No squads yet',
      noSquadsDesc: 'Create or join a squad for social accountability.',
      code: 'Code',
      createSquad: 'Create Squad',
      squadName: 'SQUAD NAME',
      squadNamePlaceholder: 'E.g.: Total Discipline',
      joinSquad: 'Join Squad',
      squadCode: 'SQUAD CODE',
      squadCodePlaceholder: 'E.g.: a1b2c3d4',
      back: 'Back',
      codeLabel: 'CODE',
      ranking: 'RANKING',
      noMembers: 'No members found',
      days: 'days',
      failures: 'failures',
      leaveSquad: 'Leave squad',
      leaveTitle: 'Leave Squad',
      leaveMessage: 'Leave "{name}"? This cannot be undone.',
      cancel: 'Cancel',
      leave: 'Leave',
      errorInvalidCode: 'Invalid code or you are already a member of this squad.',
    },
    trophies: {
      title: 'Achievements',
      daysCompleted: 'days completed',
      achievements: {
        firstStep: 'First Step',
        firstStepDesc: 'Complete your first day',
        solidStart: 'Solid Start',
        solidStartDesc: 'Complete 3 consecutive days',
        steadyHand: 'Steady Hand',
        steadyHandDesc: 'Complete 5 days',
        weekWarrior: 'Week Warrior',
        weekWarriorDesc: 'Complete 7 days',
        doubleDigits: 'Double Digits',
        doubleDigitsDesc: 'Complete 10 days',
        twoWeeks: 'Two Weeks',
        twoWeeksDesc: 'Complete 14 days',
        habit21: '21-Day Habit',
        habit21Desc: 'Complete 21 days',
        monthMaster: 'Month Master',
        monthMasterDesc: 'Complete 30 days',
        halfwayThere: 'Halfway There',
        halfwayThereDesc: 'Complete 33 days',
        ironWill: 'Iron Will',
        ironWillDesc: 'Complete 40 days',
        unstoppable: 'Unstoppable',
        unstoppableDesc: 'Complete 50 days',
        diamondHands: 'Diamond Hands',
        diamondHandsDesc: 'Complete 60 days',
        trueDiscipline: 'True Discipline',
        trueDisciplineDesc: 'Complete 66 days',
        zeroFails: 'Zero Fails',
        zeroFailsDesc: 'Complete contract with 0 fails',
        legend: 'Legend',
        legendDesc: 'Complete 3 contracts',
      },
    },
    profile: {
      title: 'Profile',
      active: 'Active',
      activeContract: 'Active Contract',
      rule: 'Rule',
      duration: 'Duration',
      deadline: 'Deadline',
      startDate: 'Start Date',
      remaining: 'Remaining',
      days: 'days',
      statistics: 'STATISTICS',
      completed: 'Completed',
      failed: 'Failed',
      rate: 'Rate',
      streak: 'Streak',
      bestStreak: 'Best streak',
      day: 'day',
      settings: 'SETTINGS',
      dailyReminder: 'Daily Reminder',
      language: 'Language',
      difficulty: 'Difficulty',
      aboutRigor: 'About RIGOR',
      signOut: 'Sign Out',
      signOutConfirm: 'Are you sure you want to sign out?',
      resetAll: 'Reset all data',
      resetTitle: 'Reset Everything',
      resetMessage: 'This will delete your contract, all records, and squads. This cannot be undone.',
      reset: 'Reset',
      cancel: 'Cancel',
      resetProgress: 'Reset progress',
      resetProgressFree: '1 free reset available',
      resetProgressUsed: 'Free reset used',
      resetProgressPro: 'Unlimited resets',
      resetProgressTitle: 'Reset Progress',
      resetProgressMessage: 'This will delete all your contracts and daily records. Your squads will be kept. This cannot be undone.',
      resetProgressConfirm: 'Reset Progress',
      noResetsLeft: 'No free resets left. Upgrade to PRO for unlimited resets.',
      permissionNeeded: 'Permission needed',
      permissionMessage: 'Enable notifications in your device settings to receive reminders.',
      english: 'English',
      portuguese: 'Portuguese',
      languageTitle: 'Language',
      difficultyTitle: 'Difficulty',
      difficultyWarning: 'Warning: this will replace your current missions.',
      medium: 'Medium',
      hard: 'Hard',
      extreme: 'Extreme',
      mission: 'mission',
      missions: 'missions',
      pro: 'PRO',
    },
    createContract: {
      title: 'New Contract',
      step1Title: 'Define your rule',
      step1Desc: 'A specific action you commit to every day. One rule. No negotiation.',
      inputPlaceholder: 'e.g., "Workout", "Study for 1 hour"',
      next: 'Next',
      step2Title: 'Set the deadline',
      step2Desc: 'The time limit to complete it each day. Missed the deadline? Failure recorded.',
      deadlineNote: 'Every 7 consecutive days, your deadline shrinks by 30 min.',
      step3Title: 'Choose duration',
      step3Desc: 'Once signed, it can\'t be edited, paused, or cancelled. The contract is irreversible.',
      days: 'days',
      contractSummary: 'Contract Summary',
      rule: 'Rule',
      deadline: 'Deadline',
      duration: 'Duration',
      warning: 'No editing. No pausing. No excuses. This is irreversible.',
      signContract: 'Sign Contract',
    },
    shareCard: {
      title: 'Share',
      day: 'DAY',
      consistencyMap: 'CONSISTENCY MAP',
      completed: 'Completed',
      failed: 'Failed',
      critical: 'Critical',
      rate: 'Rate',
      contract: 'Contract',
      download: 'Download image',
      hint: 'PNG · Instagram ready',
    },
    pro: {
      upgradeTitle: 'Upgrade to Pro',
      upgradeSubtitle: 'Unlock the full RIGOR experience',
      feature1: 'Unlimited missions & challenges',
      feature2: 'Unlimited progress resets',
      feature3: 'Hard & Extreme difficulty modes',
      monthly: 'Monthly',
      monthlyDesc: 'Cancel anytime',
      monthlyPrice: '$4.99/month',
      annual: 'Annual',
      annualBadge: 'BEST VALUE',
      annualDesc: 'Save 50%',
      annualPrice: '$29/year',
      continue: 'Continue',
      restorePurchase: 'Restore Purchase',
      termsOfUse: 'Terms of Use',
      privacyPolicy: 'Privacy Policy',
    },
    about: {
      title: 'About',
      version: 'Version 1.0.0',
      description: 'RIGOR is a discipline tracking app built on commitment. Create irreversible contracts with yourself, track your daily consistency, and build unbreakable habits.',
      irreversibleContracts: 'Irreversible Contracts',
      irreversibleContractsDesc: 'Once signed, no editing, no pausing, no excuses',
      consistencyHeatmap: 'Consistency Heatmap',
      consistencyHeatmapDesc: 'Visualize your discipline over time',
      squads: 'Squads',
      squadsDesc: 'Accountability groups to keep you honest',
      trophies: 'Trophies',
      trophiesDesc: 'Earn achievements for your dedication',
      shrinkingDeadlines: 'Shrinking Deadlines',
      shrinkingDeadlinesDesc: 'Every 7-day streak cuts 30 min from your deadline',
      footer: 'Built with discipline, for the disciplined.',
    },
    auth: {
      login: 'Sign In',
      loginTitle: 'Welcome back',
      loginSubtitle: 'Sign in to continue',
      signup: 'Sign Up',
      signupTitle: 'Create Account',
      signupSubtitle: 'Start your discipline journey',
      email: 'Email',
      username: 'Username',
      usernamePlaceholder: 'e.g. john_doe',
      password: 'Password',
      forgotPassword: 'Forgot password?',
      noAccount: "Don't have an account?",
      haveAccount: 'Already have an account?',
      forgotTitle: 'Forgot Password',
      forgotSubtitle: 'Enter your email to reset your password',
      sendReset: 'Send Reset Link',
      backToLogin: 'Back to Sign In',
    },
  },
  pt: {
    tabs: {
      today: 'Hoje',
      progress: 'Progresso',
      squads: 'Squads',
      trophies: 'Troféus',
      profile: 'Perfil',
    },
    today: {
      noContract: 'Nenhum contrato ativo',
      noContractDesc: 'Assine seu primeiro contrato para começar.',
      signFirst: 'Assinar meu primeiro contrato',
      day: 'DIA',
      completed: 'CUMPRIDOS',
      failed: 'FALHAS',
      before: 'antes das',
      remaining: 'restantes',
      streak: 'Sequência',
      noReturn: 'Sem volta',
      dayCompleted: 'Dia concluído',
      done: 'Concluir',
      newDay: 'Novo Dia!',
      newDayQuestion: 'Você completou sua missão ontem?',
      yesCompleted: 'Sim, eu completei!',
      noFailed: 'Não, eu falhei...',
      beHonest: 'Seja honesto! Seu progresso depende disso.',
    },
    progress: {
      title: 'Progresso',
      active: 'ativo',
      rate: 'TAXA',
      done: 'FEITOS',
      fails: 'FALHAS',
      consistencyMap: 'MAPA DE CONSISTÊNCIA',
      legendDone: 'Cumprido',
      legendFail: 'Falha',
      legendCritical: 'Crítica',
      insights: 'INSIGHTS',
      bestStreak: 'Melhor sequência',
      currentStreak: 'Sequência atual',
      day: 'dia',
      days: 'dias',
    },
    squads: {
      title: 'Squads',
      create: 'Criar',
      join: 'Entrar',
      noSquads: 'Nenhum squad ainda',
      noSquadsDesc: 'Crie ou entre em um squad para ter responsabilidade social.',
      code: 'Código',
      createSquad: 'Criar Squad',
      squadName: 'NOME DO SQUAD',
      squadNamePlaceholder: 'Ex: Disciplina Total',
      joinSquad: 'Entrar no Squad',
      squadCode: 'CÓDIGO DO SQUAD',
      squadCodePlaceholder: 'Ex: a1b2c3d4',
      back: 'Voltar',
      codeLabel: 'CÓDIGO',
      ranking: 'RANKING',
      noMembers: 'Nenhum membro encontrado',
      days: 'dias',
      failures: 'falhas',
      leaveSquad: 'Sair do squad',
      leaveTitle: 'Sair do Squad',
      leaveMessage: 'Sair de "{name}"? Isso não pode ser desfeito.',
      cancel: 'Cancelar',
      leave: 'Sair',
      errorInvalidCode: 'Código inválido ou você já faz parte deste squad.',
    },
    trophies: {
      title: 'Conquistas',
      daysCompleted: 'dias cumpridos',
      achievements: {
        firstStep: 'Primeiro Passo',
        firstStepDesc: 'Complete seu primeiro dia',
        solidStart: 'Começo Sólido',
        solidStartDesc: 'Complete 3 dias consecutivos',
        steadyHand: 'Mão Firme',
        steadyHandDesc: 'Complete 5 dias',
        weekWarrior: 'Guerreiro da Semana',
        weekWarriorDesc: 'Complete 7 dias',
        doubleDigits: 'Dígitos Duplos',
        doubleDigitsDesc: 'Complete 10 dias',
        twoWeeks: 'Duas Semanas',
        twoWeeksDesc: 'Complete 14 dias',
        habit21: 'Hábito de 21 Dias',
        habit21Desc: 'Complete 21 dias',
        monthMaster: 'Mestre do Mês',
        monthMasterDesc: 'Complete 30 dias',
        halfwayThere: 'Metade do Caminho',
        halfwayThereDesc: 'Complete 33 dias',
        ironWill: 'Vontade de Ferro',
        ironWillDesc: 'Complete 40 dias',
        unstoppable: 'Imparável',
        unstoppableDesc: 'Complete 50 dias',
        diamondHands: 'Mãos de Diamante',
        diamondHandsDesc: 'Complete 60 dias',
        trueDiscipline: 'Disciplina Verdadeira',
        trueDisciplineDesc: 'Complete 66 dias',
        zeroFails: 'Zero Falhas',
        zeroFailsDesc: 'Complete contrato com 0 falhas',
        legend: 'Lenda',
        legendDesc: 'Complete 3 contratos',
      },
    },
    profile: {
      title: 'Perfil',
      active: 'Ativo',
      activeContract: 'Contrato Ativo',
      rule: 'Regra',
      duration: 'Duração',
      deadline: 'Prazo',
      startDate: 'Data de Início',
      remaining: 'Restante',
      days: 'dias',
      statistics: 'ESTATÍSTICAS',
      completed: 'Cumpridos',
      failed: 'Falhas',
      rate: 'Taxa',
      streak: 'Sequência',
      bestStreak: 'Melhor sequência',
      day: 'dia',
      settings: 'CONFIGURAÇÕES',
      dailyReminder: 'Lembrete Diário',
      language: 'Idioma',
      difficulty: 'Dificuldade',
      aboutRigor: 'Sobre o RIGOR',
      signOut: 'Sair',
      signOutConfirm: 'Tem certeza que deseja sair?',
      resetAll: 'Resetar todos os dados',
      resetTitle: 'Resetar Tudo',
      resetMessage: 'Isso irá deletar seu contrato, todos os registros e squads. Isso não pode ser desfeito.',
      reset: 'Resetar',
      cancel: 'Cancelar',
      resetProgress: 'Resetar progresso',
      resetProgressFree: '1 reset gratuito disponível',
      resetProgressUsed: 'Reset gratuito utilizado',
      resetProgressPro: 'Resets ilimitados',
      resetProgressTitle: 'Resetar Progresso',
      resetProgressMessage: 'Isso irá deletar todos os seus contratos e registros diários. Seus squads serão mantidos. Isso não pode ser desfeito.',
      resetProgressConfirm: 'Resetar Progresso',
      noResetsLeft: 'Sem resets gratuitos. Atualize para PRO para resets ilimitados.',
      permissionNeeded: 'Permissão necessária',
      permissionMessage: 'Ative as notificações nas configurações do dispositivo para receber lembretes.',
      english: 'English',
      portuguese: 'Português',
      languageTitle: 'Idioma',
      difficultyTitle: 'Dificuldade',
      difficultyWarning: 'Aviso: isso substituirá suas missões atuais.',
      medium: 'Medium',
      hard: 'Hard',
      extreme: 'Extreme',
      mission: 'missão',
      missions: 'missões',
      pro: 'PRO',
    },
    createContract: {
      title: 'Novo Contrato',
      step1Title: 'Defina sua regra',
      step1Desc: 'Uma ação específica que você se compromete a fazer todos os dias. Uma regra. Sem negociação.',
      inputPlaceholder: 'Ex: "Treinar", "Estudar 1 hora"',
      next: 'Próximo',
      step2Title: 'Defina o prazo',
      step2Desc: 'O limite de tempo para cumprir a cada dia. Perdeu o prazo? Falha registrada.',
      deadlineNote: 'A cada 7 dias consecutivos, seu prazo diminui em 30 min.',
      step3Title: 'Escolha a duração',
      step3Desc: 'Depois de assinado, não pode ser editado, pausado ou cancelado. O contrato é irreversível.',
      days: 'dias',
      contractSummary: 'Resumo do Contrato',
      rule: 'Regra',
      deadline: 'Prazo',
      duration: 'Duração',
      warning: 'Sem edição. Sem pausa. Sem desculpas. Isso é irreversível.',
      signContract: 'Assinar Contrato',
    },
    shareCard: {
      title: 'Compartilhar',
      day: 'DIA',
      consistencyMap: 'MAPA DE CONSISTÊNCIA',
      completed: 'Cumprido',
      failed: 'Falha',
      critical: 'Crítica',
      rate: 'Taxa',
      contract: 'Contrato',
      download: 'Baixar imagem',
      hint: 'PNG · Pronto para Instagram',
    },
    pro: {
      upgradeTitle: 'Upgrade to Pro',
      upgradeSubtitle: 'Desbloqueie a experiência RIGOR completa',
      feature1: 'Missões e desafios ilimitados',
      feature2: 'Resets de progresso ilimitados',
      feature3: 'Modos de dificuldade Hard e Extreme',
      monthly: 'Mensal',
      monthlyDesc: 'Cancele quando quiser',
      monthlyPrice: '$4,99/mês',
      annual: 'Anual',
      annualBadge: 'MELHOR VALOR',
      annualDesc: 'Economize 50%',
      annualPrice: '$29/ano',
      continue: 'Continuar',
      restorePurchase: 'Restaurar Compra',
      termsOfUse: 'Termos de Uso',
      privacyPolicy: 'Política de Privacidade',
    },
    about: {
      title: 'Sobre',
      version: 'Versão 1.0.0',
      description: 'RIGOR é um app de rastreamento de disciplina baseado em compromisso. Crie contratos irreversíveis consigo mesmo, acompanhe sua consistência diária e construa hábitos inquebráveis.',
      irreversibleContracts: 'Contratos Irreversíveis',
      irreversibleContractsDesc: 'Uma vez assinado, sem edição, sem pausa, sem desculpas',
      consistencyHeatmap: 'Mapa de Consistência',
      consistencyHeatmapDesc: 'Visualize sua disciplina ao longo do tempo',
      squads: 'Squads',
      squadsDesc: 'Grupos de responsabilidade para te manter honesto',
      trophies: 'Troféus',
      trophiesDesc: 'Ganhe conquistas pela sua dedicação',
      shrinkingDeadlines: 'Prazos Reduzidos',
      shrinkingDeadlinesDesc: 'A cada sequência de 7 dias, 30 min são cortados do seu prazo',
      footer: 'Construído com disciplina, para os disciplinados.',
    },
    auth: {
      login: 'Entrar',
      loginTitle: 'Bem-vindo de volta',
      loginSubtitle: 'Entre para continuar',
      signup: 'Criar Conta',
      signupTitle: 'Criar Conta',
      signupSubtitle: 'Comece sua jornada de disciplina',
      email: 'Email',
      username: 'Nome de usuário',
      usernamePlaceholder: 'Ex: joao_silva',
      password: 'Senha',
      forgotPassword: 'Esqueceu a senha?',
      noAccount: 'Não tem uma conta?',
      haveAccount: 'Já tem uma conta?',
      forgotTitle: 'Esqueceu a Senha',
      forgotSubtitle: 'Digite seu email para resetar sua senha',
      sendReset: 'Enviar Link de Reset',
      backToLogin: 'Voltar para Login',
    },
  },
} as const;

type Translations = typeof translations['en'];

interface I18nContextValue {
  language: Language;
  setLanguage: (lang: Language) => Promise<void>;
  t: Translations;
}

const I18nContext = createContext<I18nContextValue | null>(null);

export function I18nProvider({ children }: { children: ReactNode }) {
  const [language, setLanguageState] = useState<Language>('en');
  const [loaded, setLoaded] = useState(false);

  useEffect(() => {
    AsyncStorage.getItem(LANGUAGE_KEY).then((val) => {
      if (val === 'pt' || val === 'en') setLanguageState(val);
      setLoaded(true);
    }).catch(() => setLoaded(true));
  }, []);

  const setLanguage = useCallback(async (lang: Language) => {
    setLanguageState(lang);
    await AsyncStorage.setItem(LANGUAGE_KEY, lang);
  }, []);

  const t = translations[language];

  const value = useMemo(() => ({
    language,
    setLanguage,
    t,
  }), [language, setLanguage, t]);

  if (!loaded) return null;

  return (
    <I18nContext.Provider value={value}>
      {children}
    </I18nContext.Provider>
  );
}

export function useI18n() {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used within an I18nProvider');
  }
  return context;
}
